{% extends "base.html" %}

{% block title %}Edit Product - {{ business_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideInDown 0.6s ease;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .page-header h2 {
        background: linear-gradient(135deg, #F59E0B, #D97706);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
        font-weight: 800;
    }

    /* Glassmorphism Form Card */
    .form-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        animation: slideInUp 0.6s ease;
        overflow: hidden;
    }

    @keyframes slideInUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Glassmorphic Form Sections */
    .form-section {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.05));
        backdrop-filter: blur(10px);
        border-left: 4px solid transparent;
        border-image: linear-gradient(135deg, #F59E0B, #D97706) 1;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 16px;
        animation: fadeIn 0.8s ease forwards;
        opacity: 0;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .form-section h5 {
        background: linear-gradient(135deg, #F59E0B, #D97706);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    /* Modern Form Labels */
    .form-label {
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }

    /* Glassmorphic Form Controls */
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        border: 2px solid rgba(245, 158, 11, 0.2);
        padding: 0.75rem 1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .form-control:focus, .form-select:focus {
        background: white;
        border-color: #F59E0B;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
        transform: translateY(-2px);
    }

    .required-field::after {
        content: "*";
        color: #EF4444;
        margin-left: 4px;
    }

    /* Glassmorphic Image Preview */
    .image-preview {
        width: 200px;
        height: 200px;
        border: 3px dashed rgba(245, 158, 11, 0.3);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .image-preview:hover {
        border-color: #F59E0B;
        background: rgba(245, 158, 11, 0.1);
        transform: scale(1.05);
        box-shadow: 0 8px 32px rgba(245, 158, 11, 0.2);
    }

    .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
    }

    .image-placeholder {
        text-align: center;
        color: #6B7280;
    }

    /* Gradient Update Button with Ripple */
    .btn-update {
        background: linear-gradient(135deg, #F59E0B, #D97706);
        border: none;
        padding: 1rem 2.5rem;
        font-weight: 700;
        border-radius: 12px;
        color: white;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    .btn-update::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn-update:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-update:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        color: white;
    }

    /* Glassmorphic Cancel Button */
    .btn-cancel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 1rem 2.5rem;
        font-weight: 600;
        border-radius: 12px;
        border: 2px solid rgba(107, 114, 128, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-cancel:hover {
        background: rgba(107, 114, 128, 0.1);
        border-color: #6B7280;
        transform: translateY(-2px);
    }

    /* Barcode Generate Link */
    .barcode-generate {
        cursor: pointer;
        background: linear-gradient(135deg, #F59E0B, #D97706);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s;
    }

    .barcode-generate:hover {
        text-decoration: underline;
        transform: translateX(3px);
    }

    /* Glassmorphic Input Group */
    .input-group-text {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
        backdrop-filter: blur(10px);
        border: 2px solid rgba(245, 158, 11, 0.2);
        border-right: none;
        border-radius: 12px 0 0 12px;
        color: #F59E0B;
        font-weight: 600;
    }

    .input-group .form-control {
        border-left: none;
        border-radius: 0 12px 12px 0;
    }

    .help-text {
        font-size: 0.85rem;
        color: #6B7280;
        margin-top: 0.25rem;
        font-weight: 500;
    }

    /* Profit Display */
    #profit_display {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
        backdrop-filter: blur(10px);
        border: 2px solid rgba(16, 185, 129, 0.3);
        font-weight: 700;
        color: #059669;
    }

    /* Stock History Link */
    .stock-history-link {
        background: linear-gradient(135deg, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .stock-history-link:hover {
        text-decoration: underline;
    }

    /* Glassmorphic Alert */
    .alert-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        backdrop-filter: blur(10px);
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-radius: 12px;
    }

    /* Glassmorphic Modal */
    .modal-content {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        border-bottom: 2px solid rgba(59, 130, 246, 0.1);
    }

    .modal-header .modal-title {
        background: linear-gradient(135deg, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
    }

    .modal-footer {
        border-top: 2px solid rgba(59, 130, 246, 0.1);
    }

    /* Form Switch */
    .form-check-input:checked {
        background: linear-gradient(135deg, #F59E0B, #D97706);
        border-color: #F59E0B;
    }

    /* Delete Button */
    .btn-danger {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        border: none;
        font-weight: 600;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }

    .btn-danger::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn-danger:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-danger:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-edit"></i> Edit Product</h2>
            <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Inventory
            </a>
        </div>

        <form method="POST" action="{{ url_for('inventory.edit_product', product_id=product.id) }}" enctype="multipart/form-data" id="productForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="card form-card">
                <div class="card-body p-4">
                    <!-- Basic Information -->
                    <div class="form-section" style="animation-delay: 0.1s;">
                        <h5><i class="fas fa-info-circle"></i> Basic Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label required-field">Product Name</label>
                                    <input type="text"
                                           class="form-control"
                                           id="name"
                                           name="name"
                                           required
                                           value="{{ product.name }}"
                                           placeholder="Enter product name">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="code" class="form-label required-field">Product Code</label>
                                    <input type="text"
                                           class="form-control"
                                           id="code"
                                           name="code"
                                           required
                                           value="{{ product.code }}"
                                           placeholder="e.g., PRD001">
                                    <small class="help-text">Unique product identifier</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="barcode" class="form-label">Barcode</label>
                                    <input type="text"
                                           class="form-control"
                                           id="barcode"
                                           name="barcode"
                                           value="{{ product.barcode or '' }}"
                                           placeholder="Scan or enter barcode">
                                    <a href="#" class="barcode-generate" onclick="generateBarcode(); return false;">
                                        <i class="fas fa-sync"></i> Auto-generate
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="category_id" class="form-label">Category</label>
                                    <select class="form-select" id="category_id" name="category_id">
                                        <option value="">Select Category</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="brand" class="form-label">Brand</label>
                                    <input type="text"
                                           class="form-control"
                                           id="brand"
                                           name="brand"
                                           value="{{ product.brand or '' }}"
                                           placeholder="e.g., Dior, Chanel">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="size" class="form-label">Size / Volume</label>
                                    <input type="text"
                                           class="form-control"
                                           id="size"
                                           name="size"
                                           value="{{ product.size or '' }}"
                                           placeholder="e.g., 100ml, 50g">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control"
                                      id="description"
                                      name="description"
                                      rows="3"
                                      placeholder="Enter product description (optional)">{{ product.description or '' }}</textarea>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="form-section" style="animation-delay: 0.2s;">
                        <h5><i class="fas fa-calculator"></i> Cost Breakdown</h5>
                        <p class="text-muted small mb-3">Break down the total cost into components for accurate landed cost calculation</p>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="base_cost" class="form-label required-field">Base Cost (Supplier)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number"
                                               class="form-control"
                                               id="base_cost"
                                               name="base_cost"
                                               step="0.01"
                                               min="0"
                                               required
                                               value="{{ product.base_cost or product.cost_price or 0 }}"
                                               placeholder="0.00"
                                               onchange="calculateLandedCost()">
                                    </div>
                                    <small class="help-text">Price from supplier</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="packaging_cost" class="form-label">Packaging Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number"
                                               class="form-control"
                                               id="packaging_cost"
                                               name="packaging_cost"
                                               step="0.01"
                                               min="0"
                                               value="{{ product.packaging_cost or 0 }}"
                                               placeholder="0.00"
                                               onchange="calculateLandedCost()">
                                    </div>
                                    <small class="help-text">Box, wrapper, etc.</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="delivery_cost" class="form-label">Delivery Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number"
                                               class="form-control"
                                               id="delivery_cost"
                                               name="delivery_cost"
                                               step="0.01"
                                               min="0"
                                               value="{{ product.delivery_cost or 0 }}"
                                               placeholder="0.00"
                                               onchange="calculateLandedCost()">
                                    </div>
                                    <small class="help-text">Freight/shipping per unit</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="bottle_cost" class="form-label">Bottle Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number"
                                               class="form-control"
                                               id="bottle_cost"
                                               name="bottle_cost"
                                               step="0.01"
                                               min="0"
                                               value="{{ product.bottle_cost or 0 }}"
                                               placeholder="0.00"
                                               onchange="calculateLandedCost()">
                                    </div>
                                    <small class="help-text">Perfume bottles</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="alert alert-success mb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong><i class="fas fa-box-open me-1"></i> Landed Cost:</strong>
                                        <span id="landed_cost_display" class="fs-5 fw-bold">Rs. {{ product.cost_price or 0 }}</span>
                                    </div>
                                    <small class="text-muted">Base + Packaging + Delivery + Bottle</small>
                                    <input type="hidden" id="cost_price" name="cost_price" value="{{ product.cost_price or 0 }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing -->
                    <div class="form-section" style="animation-delay: 0.25s;">
                        <h5><i class="fas fa-tags"></i> Selling Price</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="selling_price" class="form-label required-field">Selling Price</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs.</span>
                                        <input type="number"
                                               class="form-control"
                                               id="selling_price"
                                               name="selling_price"
                                               step="0.01"
                                               min="0"
                                               required
                                               value="{{ product.selling_price }}"
                                               placeholder="0.00"
                                               onchange="calculateProfit()">
                                    </div>
                                    <small class="help-text">Price customers will pay</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Profit Margin</label>
                                    <div class="form-control bg-light" id="profit_display" style="font-weight: 600; color: #059669;">
                                        Rs. 0.00 (0%)
                                    </div>
                                    <small class="help-text">Automatically calculated</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="tax_rate" class="form-label">Tax Rate (%)</label>
                                    <input type="number"
                                           class="form-control"
                                           id="tax_rate"
                                           name="tax_rate"
                                           step="0.01"
                                           min="0"
                                           max="100"
                                           value="{{ product.tax_rate }}"
                                           placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory -->
                    <div class="form-section" style="animation-delay: 0.3s;">
                        <h5><i class="fas fa-warehouse"></i> Inventory</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Current stock: <strong>{{ product.quantity }} units</strong>
                            {% if product.is_low_stock %}
                            <span class="badge bg-warning text-dark ms-2">Low Stock</span>
                            {% endif %}
                            {% if product.expiry_date %}
                            <span class="badge bg-{{ product.expiry_badge_class }} ms-2">
                                {% if product.is_expired %}
                                    <i class="fas fa-times-circle"></i> Expired
                                {% elif product.is_expiring_critical %}
                                    <i class="fas fa-exclamation-triangle"></i> Expiring Soon ({{ product.days_until_expiry }} days)
                                {% elif product.is_expiring_soon %}
                                    <i class="fas fa-clock"></i> Expires in {{ product.days_until_expiry }} days
                                {% else %}
                                    <i class="fas fa-check-circle"></i> Expires {{ product.expiry_date.strftime('%Y-%m-%d') }}
                                {% endif %}
                            </span>
                            {% endif %}
                            <a href="{{ url_for('inventory.stock_movements', product_id=product.id) }}" class="stock-history-link float-end">
                                <i class="fas fa-history"></i> View Stock History
                            </a>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="reorder_level" class="form-label">Reorder Level</label>
                                    <input type="number"
                                           class="form-control"
                                           id="reorder_level"
                                           name="reorder_level"
                                           min="0"
                                           value="{{ product.reorder_level }}"
                                           placeholder="10">
                                    <small class="help-text">Alert when stock reaches this level</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="expiry_date" class="form-label">
                                        <i class="fas fa-calendar-times text-danger"></i> Expiry Date
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="expiry_date"
                                           name="expiry_date"
                                           value="{{ product.expiry_date.strftime('%Y-%m-%d') if product.expiry_date else '' }}"
                                           placeholder="YYYY-MM-DD">
                                    <small class="help-text">Optional - for perishable products</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="supplier_id" class="form-label">Supplier</label>
                                    <select class="form-select" id="supplier_id" name="supplier_id">
                                        <option value="">Select Supplier</option>
                                        {% for supplier in suppliers %}
                                        <option value="{{ supplier.id }}" {% if product.supplier_id == supplier.id %}selected{% endif %}>
                                            {{ supplier.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Quick Stock Adjustment</label>
                                    <a href="{{ url_for('inventory.adjust_stock_page', product_id=product.id) }}" class="btn btn-primary w-100">
                                        <i class="fas fa-boxes"></i> Adjust Stock
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Image -->
                    <div class="form-section" style="animation-delay: 0.4s;">
                        <h5><i class="fas fa-image"></i> Product Image</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Image Preview</label>
                                <div class="image-preview" onclick="$('#image').click()">
                                    {% if product.image_url %}
                                    <img id="imagePreview" src="{{ product.image_url }}">
                                    {% else %}
                                    <div class="image-placeholder" id="imagePlaceholder">
                                        <i class="fas fa-cloud-upload-alt fa-3x mb-2"></i>
                                        <p>Click to upload image</p>
                                        <small>JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <img id="imagePreview" style="display: none;">
                                    {% endif %}
                                </div>
                                <input type="file"
                                       id="image"
                                       name="image"
                                       accept="image/*"
                                       style="display: none;"
                                       onchange="previewImage(this)">
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">Or Image URL</label>
                                <input type="url"
                                       class="form-control"
                                       id="image_url"
                                       name="image_url"
                                       value="{{ product.image_url or '' }}"
                                       placeholder="https://example.com/product-image.jpg">
                                <small class="help-text">Alternatively, provide a direct URL to the product image</small>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Settings -->
                    <div class="form-section" style="animation-delay: 0.5s;">
                        <h5><i class="fas fa-cog"></i> Additional Settings</h5>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="is_active"
                                   name="is_active"
                                   {% if product.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                <strong>Active Product</strong>
                                <small class="d-block text-muted">Inactive products won't appear in POS</small>
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="is_made_to_order"
                                   name="is_made_to_order"
                                   {% if product.is_made_to_order %}checked{% endif %}>
                            <label class="form-check-label" for="is_made_to_order">
                                <strong><i class="fas fa-flask text-primary"></i> Made to Order (Fill on Demand)</strong>
                                <small class="d-block text-muted">
                                    When sold, automatically deduct raw materials (oil + bottle) based on linked recipe.
                                    <br>Use this for attars that are filled from bulk oil stock when customer orders.
                                </small>
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="is_manufactured"
                                   name="is_manufactured"
                                   {% if product.is_manufactured %}checked{% endif %}>
                            <label class="form-check-label" for="is_manufactured">
                                <strong>Manufactured In-House</strong>
                                <small class="d-block text-muted">This product is made/blended in your facility</small>
                            </label>
                        </div>
                        {% if product.recipes %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Linked Recipe:</strong> {{ product.recipes[0].name }} ({{ product.recipes[0].code }})
                            <br><small>Raw materials will be auto-deducted when this product is sold with "Made to Order" enabled.</small>
                        </div>
                        {% else %}
                        <div class="alert alert-warning" id="no-recipe-warning" {% if not product.is_made_to_order %}style="display:none;"{% endif %}>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No Recipe Linked!</strong> Create a recipe and link it to this product for auto-deduction to work.
                            <a href="{{ url_for('production.add_recipe') }}" class="btn btn-sm btn-outline-warning ms-2">
                                <i class="fas fa-plus"></i> Create Recipe
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <i class="fas fa-trash"></i> Delete Product
                        </button>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('inventory.index') }}" class="btn btn-secondary btn-cancel">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-warning btn-update">
                                <i class="fas fa-save"></i> Update Product
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#imagePreview').attr('src', e.target.result).show();
            $('#imagePlaceholder').hide();
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function generateBarcode() {
    // Generate a random 13-digit barcode (EAN-13 format)
    const barcode = '2' + Math.floor(Math.random() * 1000000000000).toString().padStart(12, '0');
    $('#barcode').val(barcode);

    // Show a nice animation
    $('#barcode').addClass('bg-warning text-white');
    setTimeout(() => {
        $('#barcode').removeClass('bg-warning text-white');
    }, 500);
}

function calculateLandedCost() {
    const baseCost = parseFloat($('#base_cost').val()) || 0;
    const packagingCost = parseFloat($('#packaging_cost').val()) || 0;
    const deliveryCost = parseFloat($('#delivery_cost').val()) || 0;
    const bottleCost = parseFloat($('#bottle_cost').val()) || 0;

    const landedCost = baseCost + packagingCost + deliveryCost + bottleCost;

    $('#landed_cost_display').text('Rs. ' + landedCost.toFixed(2));
    $('#cost_price').val(landedCost.toFixed(2));

    // Recalculate profit
    calculateProfit();
}

function calculateProfit() {
    const costPrice = parseFloat($('#cost_price').val()) || 0;
    const sellingPrice = parseFloat($('#selling_price').val()) || 0;

    const profit = sellingPrice - costPrice;
    const profitPercentage = costPrice > 0 ? ((profit / costPrice) * 100) : 0;

    const profitColor = profit >= 0 ? '#059669' : '#EF4444';
    $('#profit_display')
        .html(`Rs. ${profit.toFixed(2)} (${profitPercentage.toFixed(1)}%)`)
        .css('color', profitColor);
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this product?\n\nThis action cannot be undone and will remove all associated data.')) {
        window.location.href = '{{ url_for("inventory.delete_product", product_id=product.id) }}';
    }
}

// Form validation
$('#productForm').on('submit', function(e) {
    const code = $('#code').val().trim();
    const name = $('#name').val().trim();
    const costPrice = parseFloat($('#cost_price').val());
    const sellingPrice = parseFloat($('#selling_price').val());

    if (!code || !name) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return false;
    }

    if (costPrice < 0 || sellingPrice < 0) {
        e.preventDefault();
        alert('Prices cannot be negative');
        return false;
    }

    if (sellingPrice < costPrice) {
        if (!confirm('Warning: Selling price is lower than cost price. This will result in a loss. Continue?')) {
            e.preventDefault();
            return false;
        }
    }
});

$(document).ready(function() {
    // Calculate profit on page load
    calculateProfit();
});

// Keyboard shortcuts
$(document).on('keydown', function(e) {
    // Ctrl+S - Save form
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        $('#productForm').submit();
    }
});
</script>
{% endblock %}
