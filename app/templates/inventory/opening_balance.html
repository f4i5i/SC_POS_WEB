{% extends "base.html" %}

{% block title %}Opening Balance Entry - {{ business_name }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-history text-primary me-2"></i>Opening Balance Entry</h2>
            <p class="text-muted mb-0">Add historical stock data from before the system</p>
        </div>
        <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Inventory
        </a>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <!-- Entry Form -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add Opening Balance</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="openingBalanceForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Entry Type -->
                        <div class="mb-3">
                            <label class="form-label">Entry Type <span class="text-danger">*</span></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="entry_type" id="type_product" value="product" checked>
                                <label class="btn btn-outline-primary" for="type_product">
                                    <i class="fas fa-box me-2"></i>Finished Product
                                </label>
                                <input type="radio" class="btn-check" name="entry_type" id="type_raw" value="raw_material">
                                <label class="btn btn-outline-warning" for="type_raw">
                                    <i class="fas fa-flask me-2"></i>Raw Material
                                </label>
                            </div>
                        </div>

                        <!-- Location -->
                        <div class="mb-3">
                            <label class="form-label">Location <span class="text-danger">*</span></label>
                            <select name="location_id" class="form-select" required id="location_select">
                                <option value="">Select Location</option>
                                {% for loc in locations %}
                                <option value="{{ loc.id }}">{{ loc.name }} ({{ loc.location_type }})</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Product Selection (shown when product type selected) -->
                        <div class="mb-3" id="product_section">
                            <label class="form-label">Product <span class="text-danger">*</span></label>
                            <select name="item_id" class="form-select" id="product_select">
                                <option value="">Search and select product...</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" data-type="product">
                                    {{ product.sku }} - {{ product.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Raw Material Selection (hidden by default) -->
                        <div class="mb-3 d-none" id="raw_material_section">
                            <label class="form-label">Raw Material <span class="text-danger">*</span></label>
                            <select name="raw_material_id" class="form-select" id="raw_material_select">
                                <option value="">Search and select raw material...</option>
                                {% for material in raw_materials %}
                                <option value="{{ material.id }}" data-type="raw_material" data-unit="{{ material.unit }}">
                                    {{ material.code }} - {{ material.name }} ({{ material.unit }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div class="mb-3">
                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="quantity" class="form-control" required
                                       step="0.01" min="0" placeholder="Enter quantity">
                                <span class="input-group-text" id="unit_label">units</span>
                            </div>
                        </div>

                        <!-- Entry Date -->
                        <div class="mb-3">
                            <label class="form-label">Entry Date</label>
                            <input type="date" name="entry_date" class="form-control" value="{{ today }}">
                            <small class="text-muted">Date when this stock was available (for historical records)</small>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-control" rows="2"
                                      placeholder="e.g., Bill reference, supplier info, etc."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-2"></i>Add Opening Balance
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- Help Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How to Use</h5>
                </div>
                <div class="card-body">
                    <h6>For Old Bills (Before System):</h6>
                    <ol>
                        <li><strong>Create Purchase Order</strong> with backdated "Order Date"</li>
                        <li>Add items and receive them</li>
                        <li>This automatically adds stock with proper records</li>
                    </ol>

                    <hr>

                    <h6>For Direct Stock Entry:</h6>
                    <ol>
                        <li>Select <strong>Finished Product</strong> or <strong>Raw Material</strong></li>
                        <li>Choose the <strong>Location</strong> where stock exists</li>
                        <li>Enter the <strong>Quantity</strong></li>
                        <li>Set the <strong>Date</strong> (when you had this stock)</li>
                        <li>Add any <strong>Notes</strong> (bill number, etc.)</li>
                    </ol>

                    <div class="alert alert-warning mb-0 mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> Opening balances are recorded as "Adjustment" type movements.
                        For proper bill tracking, use Purchase Orders instead.
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-link me-2"></i>Quick Links</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('purchase_orders.create') }}" class="btn btn-outline-primary">
                            <i class="fas fa-file-invoice me-2"></i>Create Purchase Order (with backdate)
                        </a>
                        <a href="{{ url_for('reports.stock_reconciliation') }}" class="btn btn-outline-info">
                            <i class="fas fa-balance-scale me-2"></i>View Stock Reconciliation
                        </a>
                        <a href="{{ url_for('reports.raw_material_stock') }}" class="btn btn-outline-warning">
                            <i class="fas fa-flask me-2"></i>View Raw Material Stock
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Select2
    $('#product_select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search and select product...',
        allowClear: true
    });

    $('#raw_material_select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search and select raw material...',
        allowClear: true
    });

    // Toggle between product and raw material
    $('input[name="entry_type"]').change(function() {
        const type = $(this).val();
        if (type === 'product') {
            $('#product_section').removeClass('d-none');
            $('#raw_material_section').addClass('d-none');
            $('#product_select').prop('disabled', false).prop('name', 'item_id');
            $('#raw_material_select').prop('disabled', true).prop('name', '');
            $('#unit_label').text('units');
        } else {
            $('#product_section').addClass('d-none');
            $('#raw_material_section').removeClass('d-none');
            $('#product_select').prop('disabled', true).prop('name', '');
            $('#raw_material_select').prop('disabled', false).prop('name', 'item_id');
        }
    });

    // Update unit label when raw material is selected
    $('#raw_material_select').change(function() {
        const selected = $(this).find(':selected');
        const unit = selected.data('unit') || 'units';
        $('#unit_label').text(unit);
    });
});
</script>
{% endblock %}
