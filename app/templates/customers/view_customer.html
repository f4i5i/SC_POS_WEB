{% extends "base.html" %}

{% block title %}{{ customer.name }} - Customer Details{% endblock %}

{% block extra_css %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .customer-header {
        background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        animation: slideInUp 0.4s;
    }

    .customer-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: white;
        color: #667EEA;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        margin-right: 2rem;
        border: 4px solid rgba(255,255,255,0.3);
    }

    .stat-box {
        background: rgba(255,255,255,0.2);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        backdrop-filter: blur(10px);
    }

    .stat-box-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .stat-box-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .info-card {
        animation: fadeIn 0.5s;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .info-row {
        display: flex;
        padding: 0.75rem 0;
        border-bottom: 1px solid #E5E7EB;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #6B7280;
        min-width: 150px;
    }

    .info-value {
        color: #1F2937;
    }

    .purchase-card {
        transition: all 0.3s;
        border-radius: 10px;
        border-left: 4px solid #3B82F6;
        animation: fadeIn 0.5s;
    }

    .purchase-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #E5E7EB;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .timeline-dot {
        position: absolute;
        left: -24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #3B82F6;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #3B82F6;
    }

    .loyalty-badge-large {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #1F2937;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn-lg {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .action-btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #9CA3AF;
    }

    .badge-status-lg {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Customer Header -->
<div class="customer-header">
    <div class="d-flex align-items-center mb-3">
        <div class="customer-avatar-large">
            {{ customer.name[0].upper() }}
        </div>
        <div class="flex-grow-1">
            <h2 class="mb-1">{{ customer.name }}</h2>
            <div class="d-flex align-items-center gap-3">
                <span class="badge-status-lg {% if customer.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                    {% if customer.is_active %}Active{% else %}Inactive{% endif %}
                </span>
                {% if customer.loyalty_points >= 100 %}
                <span class="loyalty-badge-large">
                    <i class="fas fa-star"></i> VIP Customer
                </span>
                {% endif %}
                <span class="text-white">
                    <i class="fas fa-calendar-alt"></i> Joined {{ customer.created_at.strftime('%b %Y') }}
                </span>
            </div>
        </div>
        <div>
            <a href="{{ url_for('customers.edit_customer', customer_id=customer.id) }}" class="btn btn-light me-2">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{{ url_for('customers.index') }}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-box-value">{{ customer.sales.count() }}</div>
                <div class="stat-box-label">Total Purchases</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-box-value">
                    Rs. {{ "{:,.0f}".format(customer.sales|sum(attribute='total') or 0) }}
                </div>
                <div class="stat-box-label">Total Spent</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                {% set total_sales = customer.total_purchases %}
                {% set sales_count = customer.sales.count() %}
                {% set avg_purchase = (total_sales / sales_count) if sales_count > 0 else 0 %}
                <div class="stat-box-value">
                    Rs. {{ "{:,.0f}".format(avg_purchase) }}
                </div>
                <div class="stat-box-label">Avg Purchase</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-box-value">
                    {{ customer.loyalty_points or 0 }}
                    <span class="badge bg-{{ customer.loyalty_tier_color }} ms-2" style="font-size: 0.6rem; vertical-align: super;">
                        {{ customer.loyalty_tier }}
                    </span>
                </div>
                <div class="stat-box-label">
                    Loyalty Points (Rs. {{ customer.points_value_pkr }})
                    {% if customer.next_tier_name %}
                    <br><small>{{ customer.points_to_next_tier }} to {{ customer.next_tier_name }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Customer Information -->
    <div class="col-md-4">
        <div class="card info-card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-user"></i> Customer Information</h5>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <div class="info-label"><i class="fas fa-phone"></i> Phone</div>
                    <div class="info-value">{{ customer.phone }}</div>
                </div>
                {% if customer.email %}
                <div class="info-row">
                    <div class="info-label"><i class="fas fa-envelope"></i> Email</div>
                    <div class="info-value">{{ customer.email }}</div>
                </div>
                {% endif %}
                {% if customer.cnic %}
                <div class="info-row">
                    <div class="info-label"><i class="fas fa-id-card"></i> CNIC</div>
                    <div class="info-value">{{ customer.cnic }}</div>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="info-row">
                    <div class="info-label"><i class="fas fa-map-marker-alt"></i> Address</div>
                    <div class="info-value">{{ customer.address }}</div>
                </div>
                {% endif %}
                {% if customer.notes %}
                <div class="info-row">
                    <div class="info-label"><i class="fas fa-sticky-note"></i> Notes</div>
                    <div class="info-value">{{ customer.notes }}</div>
                </div>
                {% endif %}
                <div class="info-row">
                    <div class="info-label"><i class="fas fa-star"></i> Points</div>
                    <div class="info-value text-warning fw-bold">{{ customer.loyalty_points or 0 }} points</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card info-card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body d-grid gap-2">
                <a href="{{ url_for('pos.index') }}?customer={{ customer.id }}" class="btn btn-primary action-btn-lg">
                    <i class="fas fa-cash-register"></i> New Sale
                </a>
                <button class="btn btn-warning action-btn-lg" onclick="adjustPoints()">
                    <i class="fas fa-star"></i> Adjust Points
                </button>
                <button class="btn btn-info action-btn-lg" onclick="sendMessage()">
                    <i class="fas fa-sms"></i> Send SMS
                </button>
            </div>
        </div>

        <!-- Gamified Loyalty Dashboard -->
        <div class="card info-card mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-trophy text-warning"></i> Loyalty Dashboard</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLoyaltyDashboard()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body" id="loyaltyDashboard">
                <!-- Tier Progress -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold">Tier Progress</span>
                        <span class="badge bg-{{ customer.loyalty_tier_color }}">{{ customer.loyalty_tier }}</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-{{ customer.loyalty_tier_color }}" role="progressbar"
                             id="tierProgressBar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="tierProgressText">Loading...</small>
                </div>

                <!-- Badges Earned -->
                <div class="mb-4">
                    <h6 class="mb-2"><i class="fas fa-award me-1"></i>Badges Earned</h6>
                    <div id="earnedBadges" class="d-flex flex-wrap gap-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Active Challenges -->
                <div class="mb-4">
                    <h6 class="mb-2"><i class="fas fa-flag-checkered me-1"></i>Active Challenges</h6>
                    <div id="activeChallenges">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Referral Code -->
                <div class="p-3 bg-light rounded">
                    <h6 class="mb-2"><i class="fas fa-share-alt me-1"></i>Referral Code</h6>
                    <div class="input-group">
                        <input type="text" class="form-control text-center fw-bold" id="referralCode" readonly
                               value="Loading..." style="font-family: monospace; letter-spacing: 2px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="copyReferralCode()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1" id="referralStats">Earn 100 points for each referral!</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase History -->
    <div class="col-md-8">
        <div class="card info-card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history"></i> Purchase History</h5>
                <span class="badge bg-primary">{{ customer.sales.count() }} Purchases</span>
            </div>
            <div class="card-body">
                {% if customer.sales %}
                <div class="timeline">
                    {% for sale in customer.sales|sort(attribute='sale_date', reverse=True) %}
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="card purchase-card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-receipt"></i> {{ sale.sale_number }}
                                        </h6>
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> {{ sale.sale_date.strftime('%b %d, %Y %I:%M %p') }}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-primary" style="font-size: 1.1rem;">
                                            Rs. {{ "{:,.2f}".format(sale.total) }}
                                        </div>
                                        <span class="badge
                                            {% if sale.payment_status == 'paid' %}bg-success
                                            {% elif sale.payment_status == 'partial' %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ sale.payment_status|title }}
                                        </span>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <small class="text-muted">Items purchased:</small>
                                    <div class="mt-1">
                                        {% for item in sale.items[:3] %}
                                        <span class="badge bg-light text-dark me-1">
                                            {{ item.quantity }}x {{ item.product.name }}
                                        </span>
                                        {% endfor %}
                                        {% if sale.items.count() > 3 %}
                                        <span class="badge bg-secondary">+{{ sale.items.count() - 3 }} more</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> Served by {{ sale.user.full_name if sale.user else 'N/A' }}
                                    </small>
                                    <a href="{{ url_for('pos.sale_details', sale_id=sale.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-shopping-bag fa-4x mb-3"></i>
                    <h5>No Purchase History</h5>
                    <p>This customer hasn't made any purchases yet</p>
                    <a href="{{ url_for('pos.index') }}?customer={{ customer.id }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create First Sale
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Adjust Points Modal -->
<div class="modal fade" id="adjustPointsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-star"></i> Adjust Loyalty Points</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="adjustPointsForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Points</label>
                        <input type="text" class="form-control" value="{{ customer.loyalty_points or 0 }} points" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <select class="form-select" id="points_action" required>
                            <option value="add">Add Points</option>
                            <option value="remove">Remove Points</option>
                            <option value="set">Set Points</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control" id="points_amount" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" id="points_reason" rows="2" placeholder="Enter reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let adjustPointsModal;

$(document).ready(function() {
    adjustPointsModal = new bootstrap.Modal(document.getElementById('adjustPointsModal'));

    $('#adjustPointsForm').on('submit', function(e) {
        e.preventDefault();

        const action = $('#points_action').val();
        const amount = parseInt($('#points_amount').val());
        const reason = $('#points_reason').val();

        $.ajax({
            url: `/customers/adjust-points/{{ customer.id }}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action: action,
                amount: amount,
                reason: reason
            }),
            success: function(response) {
                if (response.success) {
                    adjustPointsModal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('Error adjusting points');
            }
        });
    });
});

function adjustPoints() {
    $('#points_amount').val('');
    $('#points_reason').val('');
    $('#points_action').val('add');
    adjustPointsModal.show();
}

function sendMessage() {
    const phone = '{{ customer.phone }}';
    const message = `Dear {{ customer.name }}, thank you for being a valued customer at {{ business_name }}!`;
    alert(`SMS functionality coming soon!\n\nWill send to: ${phone}\nMessage: ${message}`);
}

// Gamified Loyalty Dashboard Functions
function refreshLoyaltyDashboard() {
    fetch(`/loyalty/customer/{{ customer.id }}/dashboard`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderLoyaltyDashboard(data);
            } else {
                console.error('Error loading loyalty data:', data.error);
                showLoyaltyError();
            }
        })
        .catch(error => {
            console.error('Error fetching loyalty data:', error);
            showLoyaltyError();
        });
}

function showLoyaltyError() {
    document.getElementById('earnedBadges').innerHTML = '<span class="text-muted small">Unable to load badges</span>';
    document.getElementById('activeChallenges').innerHTML = '<span class="text-muted small">Unable to load challenges</span>';
    document.getElementById('referralCode').value = 'N/A';
    document.getElementById('tierProgressText').textContent = 'Unable to load progress';
}

function renderLoyaltyDashboard(data) {
    // Tier Progress
    const tierProgress = data.tier_progress;
    document.getElementById('tierProgressBar').style.width = tierProgress.progress_percent + '%';
    if (tierProgress.next_tier) {
        document.getElementById('tierProgressText').textContent =
            `${tierProgress.points_to_next} points to ${tierProgress.next_tier}`;
    } else {
        document.getElementById('tierProgressText').textContent = 'Maximum tier reached!';
    }

    // Earned Badges
    const badgesContainer = document.getElementById('earnedBadges');
    if (data.badges.earned && data.badges.earned.length > 0) {
        badgesContainer.innerHTML = data.badges.earned.map(badge => `
            <div class="badge-item text-center" style="width: 60px;" title="${badge.description || badge.name}">
                <div style="width: 45px; height: 45px; background: ${badge.color}20; border-radius: 50%;
                            display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <i class="${badge.icon}" style="color: ${badge.color}; font-size: 1.2rem;"></i>
                </div>
                <small class="d-block text-truncate" style="font-size: 0.7rem;">${badge.name}</small>
            </div>
        `).join('');
    } else {
        badgesContainer.innerHTML = `
            <div class="text-muted small text-center w-100 py-2">
                <i class="fas fa-medal opacity-50 d-block mb-1" style="font-size: 1.5rem;"></i>
                No badges yet. Make a purchase to earn your first badge!
            </div>
        `;
    }

    // Available badges preview (show first 3)
    if (data.badges.available && data.badges.available.length > 0) {
        const availableHtml = `
            <div class="mt-2 pt-2 border-top">
                <small class="text-muted">Next badges to earn:</small>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    ${data.badges.available.slice(0, 3).map(badge => `
                        <span class="badge bg-light text-dark border" style="opacity: 0.6;">
                            <i class="${badge.icon} me-1"></i>${badge.name}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
        badgesContainer.innerHTML += availableHtml;
    }

    // Active Challenges
    const challengesContainer = document.getElementById('activeChallenges');
    if (data.challenges && data.challenges.length > 0) {
        challengesContainer.innerHTML = data.challenges.map(challenge => `
            <div class="challenge-item mb-2 p-2 border rounded ${challenge.completed ? 'bg-success bg-opacity-10' : ''}">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-semibold small">${challenge.name}</span>
                    ${challenge.completed ?
                        '<span class="badge bg-success"><i class="fas fa-check"></i></span>' :
                        `<span class="small text-muted">${challenge.progress_percent}%</span>`
                    }
                </div>
                <div class="progress mb-1" style="height: 5px;">
                    <div class="progress-bar ${challenge.completed ? 'bg-success' : 'bg-primary'}"
                         style="width: ${challenge.progress_percent}%"></div>
                </div>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">
                        ${challenge.current_value.toLocaleString()} / ${challenge.target_value.toLocaleString()}
                    </small>
                    <small class="text-success">
                        <i class="fas fa-gift"></i>
                        ${challenge.reward_type === 'points' ? challenge.reward_value + ' pts' :
                          challenge.reward_type === 'discount' ? challenge.reward_value + '% off' : 'Badge'}
                    </small>
                </div>
            </div>
        `).join('');
    } else {
        challengesContainer.innerHTML = `
            <div class="text-muted small text-center py-2">
                <i class="fas fa-flag-checkered opacity-50 d-block mb-1"></i>
                No active challenges right now
            </div>
        `;
    }

    // Referral Code
    document.getElementById('referralCode').value = data.referrals.code || 'N/A';
    const referralCount = data.referrals.count || 0;
    document.getElementById('referralStats').innerHTML = referralCount > 0 ?
        `<i class="fas fa-check-circle text-success"></i> ${referralCount} successful referral${referralCount > 1 ? 's' : ''} - Earn ${data.referrals.points_per_referral} points per referral!` :
        `Earn ${data.referrals.points_per_referral} points for each friend who makes a purchase!`;
}

function copyReferralCode() {
    const codeInput = document.getElementById('referralCode');
    codeInput.select();
    document.execCommand('copy');
    showToast('Referral code copied!', 'success');
}

// Load loyalty dashboard on page load
$(document).ready(function() {
    refreshLoyaltyDashboard();
});
</script>
{% endblock %}
