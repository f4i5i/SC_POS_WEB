{% extends "base.html" %}

{% block title %}Create Production Order - {{ business_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-plus-circle text-primary me-2"></i>Create Production Order</h2>
            <p class="text-muted mb-0">Start a new production run</p>
        </div>
        <a href="{{ url_for('production.orders') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>

    {% if current_location %}
    <div class="alert alert-info mb-4">
        <i class="fas fa-map-marker-alt me-2"></i>
        Production Location: <strong>{{ current_location.name }}</strong>
        {% if current_location.location_type == 'kiosk' %}
        <br><small>Note: Only attar recipes can be produced at kiosks</small>
        {% endif %}
    </div>
    {% endif %}

    <form method="POST">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Order Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Recipe <span class="text-danger">*</span></label>
                                <select name="recipe_id" class="form-select" required id="recipe-select">
                                    <option value="">Select recipe...</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe.id }}"
                                            data-type="{{ recipe.recipe_type }}"
                                            data-size="{{ recipe.output_size_ml }}"
                                            data-product="{{ recipe.product.name if recipe.product else 'No product linked' }}">
                                        {{ recipe.code }} - {{ recipe.name }} ({{ recipe.output_size_ml }}ml)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" name="quantity" class="form-control" required
                                       min="1" value="10" id="quantity-input">
                                <small class="text-muted">Number of bottles to produce</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Priority</label>
                                <select name="priority" class="form-select">
                                    <option value="normal" selected>Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Due Date</label>
                                <input type="date" name="due_date" class="form-control">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea name="notes" class="form-control" rows="2"
                                          placeholder="Any special instructions..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Requirements Preview -->
                <div class="card shadow-sm mt-4" id="materials-preview" style="display: none;">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Materials Required</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Material</th>
                                        <th class="text-end">Required</th>
                                        <th class="text-end">Available</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="materials-tbody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Summary Card -->
                <div class="card shadow-sm position-sticky" style="top: 80px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="recipe-info" class="mb-3">
                            <p class="text-muted">Select a recipe to see details</p>
                        </div>

                        <div id="availability-status" class="mb-3">
                            <!-- Availability check result -->
                        </div>

                        <hr>

                        <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                            <i class="fas fa-paper-plane me-2"></i>Create Order
                        </button>
                        <a href="{{ url_for('production.orders') }}" class="btn btn-outline-secondary w-100 mt-2">
                            Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
const recipeSelect = document.getElementById('recipe-select');
const quantityInput = document.getElementById('quantity-input');
const materialsPreview = document.getElementById('materials-preview');
const materialsTbody = document.getElementById('materials-tbody');
const recipeInfo = document.getElementById('recipe-info');
const availabilityStatus = document.getElementById('availability-status');
const locationId = {{ current_location.id if current_location else 'null' }};

function updatePreview() {
    const recipeId = recipeSelect.value;
    const quantity = quantityInput.value;

    if (!recipeId || !quantity) {
        materialsPreview.style.display = 'none';
        recipeInfo.innerHTML = '<p class="text-muted">Select a recipe to see details</p>';
        return;
    }

    // Update recipe info
    const option = recipeSelect.options[recipeSelect.selectedIndex];
    recipeInfo.innerHTML = `
        <div class="mb-2">
            <small class="text-muted">Recipe</small>
            <div class="fw-bold">${option.text}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Output Product</small>
            <div>${option.dataset.product}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Total Output</small>
            <div>${(parseFloat(option.dataset.size) * quantity).toFixed(0)}ml (${quantity} Ã— ${option.dataset.size}ml)</div>
        </div>
    `;

    // Check availability
    if (locationId) {
        fetch(`{{ url_for('production.api_check_availability') }}?recipe_id=${recipeId}&quantity=${quantity}&location_id=${locationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    availabilityStatus.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    materialsPreview.style.display = 'none';
                    return;
                }

                // Show materials table
                materialsPreview.style.display = 'block';
                materialsTbody.innerHTML = '';

                data.materials.forEach(mat => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <strong>${mat.name}</strong>
                        </td>
                        <td class="text-end">${mat.quantity_required.toFixed(2)} ${mat.unit}</td>
                        <td class="text-end">${mat.available_quantity.toFixed(2)}</td>
                        <td>
                            ${mat.is_available
                                ? '<span class="badge bg-success"><i class="fas fa-check"></i> OK</span>'
                                : `<span class="badge bg-danger"><i class="fas fa-times"></i> Short by ${mat.shortage.toFixed(2)}</span>`
                            }
                        </td>
                    `;
                    materialsTbody.appendChild(tr);
                });

                // Update status
                if (data.all_available) {
                    availabilityStatus.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            All materials available!
                        </div>
                    `;
                } else {
                    availabilityStatus.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Some materials are short. Order will be created but may require restocking.
                        </div>
                    `;
                }
            })
            .catch(err => {
                console.error('Error:', err);
                availabilityStatus.innerHTML = '<div class="alert alert-danger">Error checking availability</div>';
            });
    }
}

recipeSelect.addEventListener('change', updatePreview);
quantityInput.addEventListener('change', updatePreview);
quantityInput.addEventListener('input', updatePreview);

// Check if recipe_id was passed in URL
const urlParams = new URLSearchParams(window.location.search);
const preselectedRecipe = urlParams.get('recipe_id');
if (preselectedRecipe) {
    recipeSelect.value = preselectedRecipe;
    updatePreview();
}
</script>
{% endblock %}
