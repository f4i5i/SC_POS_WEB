{% extends "base.html" %}

{% block title %}Create Production Order - {{ business_name }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .recipe-type-filter .btn {
        border-radius: 20px;
        padding: 0.25rem 1rem;
        font-size: 0.875rem;
    }
    .recipe-type-filter .btn.active {
        font-weight: 600;
    }
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-plus-circle text-primary me-2"></i>Create Production Order</h2>
            <p class="text-muted mb-0">Start a new production run</p>
        </div>
        <a href="{{ url_for('production.orders') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>

    {% if current_location %}
    <div class="alert alert-info mb-4">
        <i class="fas fa-map-marker-alt me-2"></i>
        Production Location: <strong>{{ current_location.name }}</strong>
        {% if current_location.location_type == 'kiosk' %}
        <br><small>Note: Only attar recipes can be produced at kiosks</small>
        {% endif %}
        {% if is_global_admin and available_locations %}
        <div class="mt-2">
            <form method="GET" class="d-inline-flex align-items-center gap-2">
                <label class="mb-0"><small>Change location:</small></label>
                <select name="location_id" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                    {% for loc in available_locations %}
                    <option value="{{ loc.id }}" {% if loc.id == current_location.id %}selected{% endif %}>
                        {{ loc.name }} ({{ loc.location_type }})
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            {% if is_global_admin and current_location %}
            <input type="hidden" name="location_id" value="{{ current_location.id }}"/>
            {% endif %}
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Order Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Recipe Type Filter</label>
                                <div class="recipe-type-filter btn-group mb-2" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm active" data-filter="all">
                                        All <span class="badge bg-primary ms-1" id="count-all">{{ recipes|length }}</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" data-filter="single_oil">
                                        Single Oil <span class="badge bg-success ms-1" id="count-single_oil">{{ recipes|selectattr('recipe_type', 'equalto', 'single_oil')|list|length }}</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm" data-filter="blended">
                                        Blended <span class="badge bg-warning ms-1" id="count-blended">{{ recipes|selectattr('recipe_type', 'equalto', 'blended')|list|length }}</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" data-filter="perfume">
                                        Perfume <span class="badge bg-info ms-1" id="count-perfume">{{ recipes|selectattr('recipe_type', 'equalto', 'perfume')|list|length }}</span>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Recipe <span class="text-danger">*</span></label>
                                <select name="recipe_id" class="form-select" required id="recipe-select" data-placeholder="Search and select a recipe...">
                                    <option value="">Select recipe...</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe.id }}"
                                            data-type="{{ recipe.recipe_type }}"
                                            data-size="{{ recipe.output_size_ml }}"
                                            data-oil-percent="{{ recipe.oil_percentage or 100 }}"
                                            data-product="{{ recipe.product.name if recipe.product else 'No product linked' }}">
                                        [{{ recipe.recipe_type|upper }}] {{ recipe.code }} - {{ recipe.name }} ({{ recipe.output_size_ml }}ml{% if recipe.recipe_type == 'perfume' %}, {{ recipe.oil_percentage }}% oil{% endif %})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" name="quantity" class="form-control" required
                                       min="1" value="10" id="quantity-input">
                                <small class="text-muted">Number of bottles to produce</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Priority</label>
                                <select name="priority" class="form-select">
                                    <option value="normal" selected>Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Due Date</label>
                                <input type="date" name="due_date" class="form-control">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea name="notes" class="form-control" rows="2"
                                          placeholder="Any special instructions..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calculation Breakdown -->
                <div class="card shadow-sm mt-4" id="calculation-breakdown" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Calculation Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="calculation-cards">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Material Requirements Preview -->
                <div class="card shadow-sm mt-4" id="materials-preview" style="display: none;">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Materials Required</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Material</th>
                                        <th class="text-center">Formula</th>
                                        <th class="text-end">Required</th>
                                        <th class="text-end">Available</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="materials-tbody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Summary Card -->
                <div class="card shadow-sm position-sticky" style="top: 80px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="recipe-info" class="mb-3">
                            <p class="text-muted">Select a recipe to see details</p>
                        </div>

                        <div id="availability-status" class="mb-3">
                            <!-- Availability check result -->
                        </div>

                        <hr>

                        <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                            <i class="fas fa-paper-plane me-2"></i>Create Order
                        </button>
                        <a href="{{ url_for('production.orders') }}" class="btn btn-outline-secondary w-100 mt-2">
                            Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
const recipeSelect = document.getElementById('recipe-select');
const quantityInput = document.getElementById('quantity-input');
const materialsPreview = document.getElementById('materials-preview');
const materialsTbody = document.getElementById('materials-tbody');
const recipeInfo = document.getElementById('recipe-info');
const availabilityStatus = document.getElementById('availability-status');
const locationId = {{ current_location.id if current_location else 'null' }};

// Store all options for filtering
const allOptions = [];
document.querySelectorAll('#recipe-select option').forEach(opt => {
    if (opt.value) {
        allOptions.push({
            value: opt.value,
            text: opt.text,
            type: opt.dataset.type,
            size: opt.dataset.size,
            oilPercent: opt.dataset.oilPercent,
            product: opt.dataset.product
        });
    }
});

// Initialize Select2
$(document).ready(function() {
    $('#recipe-select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search and select a recipe...',
        allowClear: true,
        width: '100%'
    });

    // Trigger updatePreview on Select2 change
    $('#recipe-select').on('change', function() {
        updatePreview();
    });
});

// Filter recipes by type
let currentFilter = 'all';
document.querySelectorAll('.recipe-type-filter button').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('.recipe-type-filter button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        currentFilter = this.dataset.filter;
        filterRecipes(currentFilter);
    });
});

function filterRecipes(filterType) {
    const select = document.getElementById('recipe-select');
    const currentValue = select.value;

    // Clear and rebuild options
    select.innerHTML = '<option value="">Select recipe...</option>';

    allOptions.forEach(opt => {
        if (filterType === 'all' || opt.type === filterType) {
            const option = document.createElement('option');
            option.value = opt.value;
            option.text = opt.text;
            option.dataset.type = opt.type;
            option.dataset.size = opt.size;
            option.dataset.oilPercent = opt.oilPercent;
            option.dataset.product = opt.product;
            select.appendChild(option);
        }
    });

    // Restore selection if still valid
    if (currentValue) {
        const stillExists = Array.from(select.options).some(o => o.value === currentValue);
        if (stillExists) {
            select.value = currentValue;
        }
    }

    // Refresh Select2
    $('#recipe-select').trigger('change.select2');
}

function updatePreview() {
    const recipeId = recipeSelect.value;
    const quantity = parseInt(quantityInput.value) || 0;

    if (!recipeId || !quantity) {
        materialsPreview.style.display = 'none';
        recipeInfo.innerHTML = '<p class="text-muted">Select a recipe to see details</p>';
        return;
    }

    // Update recipe info
    const option = recipeSelect.options[recipeSelect.selectedIndex];
    const outputSize = parseFloat(option.dataset.size) || 0;
    const oilPercent = parseFloat(option.dataset.oilPercent) || 100;
    const recipeType = option.dataset.type;
    const totalOutput = outputSize * quantity;

    let typeLabel = 'Attar';
    let typeClass = 'bg-primary';
    if (recipeType === 'perfume') {
        typeLabel = 'Perfume';
        typeClass = 'bg-info';
    } else if (recipeType === 'blended') {
        typeLabel = 'Blended';
        typeClass = 'bg-warning';
    }

    let recipeInfoHtml = `
        <div class="mb-2">
            <small class="text-muted">Recipe</small>
            <div class="fw-bold">${option.text.split(' - ')[1] || option.text}</div>
            <span class="badge ${typeClass}">${typeLabel}</span>
        </div>
        <div class="mb-2">
            <small class="text-muted">Output Product</small>
            <div>${option.dataset.product}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Total Output</small>
            <div class="h5 mb-0 text-primary">${totalOutput.toFixed(0)} ml</div>
            <small class="text-muted">(${quantity} bottles × ${outputSize} ml each)</small>
        </div>
    `;

    if (recipeType === 'perfume') {
        const oilMl = totalOutput * (oilPercent / 100);
        const ethanolMl = totalOutput - oilMl;
        recipeInfoHtml += `
            <div class="mb-2 mt-2 pt-2 border-top">
                <small class="text-muted">Composition</small>
                <div class="small">
                    <span class="badge bg-warning me-1">Oil ${oilPercent}%</span>
                    <span class="badge bg-secondary">Ethanol ${100 - oilPercent}%</span>
                </div>
            </div>
        `;
    }

    recipeInfo.innerHTML = recipeInfoHtml;

    // First get the calculation details
    fetch(`{{ url_for('production.api_calculate_requirements') }}?recipe_id=${recipeId}&quantity=${quantity}`)
        .then(response => response.json())
        .then(calcData => {
            if (calcData.error) {
                console.error(calcData.error);
                return;
            }

            // Show calculation breakdown
            const calcBreakdown = document.getElementById('calculation-breakdown');
            const calcCards = document.getElementById('calculation-cards');
            calcBreakdown.style.display = 'block';

            const totalOutput = calcData.total_output_ml;
            const oilAmount = calcData.oil_amount_ml;
            const ethanolAmount = calcData.ethanol_amount_ml;
            const oilPercent = totalOutput > 0 ? ((oilAmount / totalOutput) * 100).toFixed(0) : 100;
            const ethanolPercent = totalOutput > 0 ? ((ethanolAmount / totalOutput) * 100).toFixed(0) : 0;

            let cardsHtml = `
                <div class="col-md-4">
                    <div class="card bg-primary bg-opacity-10 border-primary">
                        <div class="card-body text-center py-3">
                            <h6 class="text-primary mb-1">Total Output</h6>
                            <h3 class="mb-0">${totalOutput.toFixed(2)} ml</h3>
                            <small class="text-muted">${quantity} × ${(totalOutput/quantity).toFixed(0)} ml</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning bg-opacity-10 border-warning">
                        <div class="card-body text-center py-3">
                            <h6 class="text-warning mb-1">Oil Required</h6>
                            <h3 class="mb-0">${oilAmount.toFixed(2)} ml</h3>
                            <small class="text-muted">${oilPercent}% of total</small>
                        </div>
                    </div>
                </div>
            `;

            if (ethanolAmount > 0) {
                cardsHtml += `
                    <div class="col-md-4">
                        <div class="card bg-info bg-opacity-10 border-info">
                            <div class="card-body text-center py-3">
                                <h6 class="text-info mb-1">Ethanol Required</h6>
                                <h3 class="mb-0">${ethanolAmount.toFixed(2)} ml</h3>
                                <small class="text-muted">${ethanolPercent}% of total</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            calcCards.innerHTML = cardsHtml;

            // Now check availability
            if (locationId) {
                return fetch(`{{ url_for('production.api_check_availability') }}?recipe_id=${recipeId}&quantity=${quantity}&location_id=${locationId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            availabilityStatus.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                            materialsPreview.style.display = 'none';
                            return;
                        }

                        // Show materials table
                        materialsPreview.style.display = 'block';
                        materialsTbody.innerHTML = '';

                        data.materials.forEach(mat => {
                            let formula = '';
                            if (mat.unit === 'pcs') {
                                formula = `${quantity} bottles`;
                            } else {
                                // Calculate formula based on type
                                const perUnit = mat.quantity_required / quantity;
                                formula = `${quantity} × ${perUnit.toFixed(2)} ml`;
                            }

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>
                                    <strong>${mat.name}</strong>
                                </td>
                                <td class="text-center">
                                    <small class="text-muted">${formula}</small>
                                </td>
                                <td class="text-end fw-bold">${mat.quantity_required.toFixed(2)} ${mat.unit}</td>
                                <td class="text-end">${mat.available_quantity.toFixed(2)}</td>
                                <td>
                                    ${mat.is_available
                                        ? '<span class="badge bg-success"><i class="fas fa-check"></i> OK</span>'
                                        : `<span class="badge bg-danger"><i class="fas fa-times"></i> Short by ${mat.shortage.toFixed(2)}</span>`
                                    }
                                </td>
                            `;
                            materialsTbody.appendChild(tr);
                        });

                        // Update status
                        if (data.all_available) {
                            availabilityStatus.innerHTML = `
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    All materials available!
                                </div>
                            `;
                        } else {
                            availabilityStatus.innerHTML = `
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Some materials are short.
                                </div>
                            `;
                        }
                    });
            }
        })
        .catch(err => {
            console.error('Error:', err);
            availabilityStatus.innerHTML = '<div class="alert alert-danger">Error checking availability</div>';
        });
}

recipeSelect.addEventListener('change', updatePreview);
quantityInput.addEventListener('change', updatePreview);
quantityInput.addEventListener('input', updatePreview);

// Check if recipe_id was passed in URL
const urlParams = new URLSearchParams(window.location.search);
const preselectedRecipe = urlParams.get('recipe_id');
if (preselectedRecipe) {
    recipeSelect.value = preselectedRecipe;
    updatePreview();
}
</script>
{% endblock %}
