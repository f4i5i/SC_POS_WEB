{% extends "base.html" %}

{% block title %}Inventory Spot Check - {{ business_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-clipboard-check text-primary me-2"></i>Inventory Spot Check</h2>
            <p class="text-muted mb-0">{{ location.name }} - {{ today.strftime('%d %b %Y') }}</p>
        </div>
        <div>
            <a href="{{ url_for('day_close.spot_check_history') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-history me-2"></i>History
            </a>
            <a href="{{ url_for('day_close.index') }}" class="btn btn-outline-primary">
                <i class="fas fa-cash-register me-2"></i>Day Close
            </a>
        </div>
    </div>

    <!-- Check Type Selector -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Check Type</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="{{ url_for('day_close.spot_check', location_id=location.id, check_type='daily') }}"
                               class="btn btn-lg w-100 {% if check_type == 'daily' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-sun me-2"></i>Daily Check
                                <div class="small">10-20 random items</div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('day_close.spot_check', location_id=location.id, check_type='random') }}"
                               class="btn btn-lg w-100 {% if check_type == 'random' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-random me-2"></i>Quick Check
                                <div class="small">5 random items</div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('day_close.spot_check', location_id=location.id, check_type='fortnightly') }}"
                               class="btn btn-lg w-100 {% if check_type == 'fortnightly' %}btn-warning{% elif fortnightly_due %}btn-outline-danger{% else %}btn-outline-warning{% endif %}">
                                <i class="fas fa-calendar-alt me-2"></i>Full Check
                                <div class="small">All {{ total_products }} items</div>
                                {% if fortnightly_due %}
                                <span class="badge bg-danger mt-1">OVERDUE</span>
                                {% endif %}
                            </a>
                        </div>
                    </div>

                    {% if last_check %}
                    <div class="mt-3 text-muted">
                        <small>
                            <i class="fas fa-clock me-1"></i>
                            Last check: {{ last_check.check_date.strftime('%d %b %Y') }} ({{ last_check.check_type }})
                            {% if days_since_full_check is not none %}
                            | Days since full check: <strong class="{% if days_since_full_check >= 14 %}text-danger{% else %}text-success{% endif %}">{{ days_since_full_check }}</strong>
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm bg-light">
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>Tips</h6>
                    <ul class="small mb-0">
                        <li>Daily check: Quick random verification</li>
                        <li>Full check: Complete inventory count every 2 weeks</li>
                        <li>Count items physically before entering</li>
                        <li>Variances require manager approval</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% if products or raw_materials %}
    <form method="POST" action="{{ url_for('day_close.save_spot_check') }}" id="spotCheckForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="location_id" value="{{ location.id }}">
        <input type="hidden" name="check_type" value="{{ check_type }}">

        <!-- Products Section -->
        {% if products %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-box me-2"></i>Products ({{ products|length }} items)</h5>
                <span class="badge bg-light text-primary">Check Type: {{ check_type|title }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px">#</th>
                                <th>Product</th>
                                <th class="text-center">System Qty</th>
                                <th class="text-center" style="width: 150px">Physical Count</th>
                                <th class="text-center">Variance</th>
                                <th style="width: 200px">Reason (if variance)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr id="row_{{ product.id }}">
                                <td>
                                    <input type="hidden" name="product_ids[]" value="{{ product.id }}">
                                    <input type="hidden" name="system_qty_{{ product.id }}" value="{{ product.system_qty }}">
                                    <input type="hidden" name="unit_cost_{{ product.id }}" value="{{ product.cost }}">
                                    {{ loop.index }}
                                </td>
                                <td>
                                    <strong>{{ product.name }}</strong>
                                    <div class="small text-muted">
                                        SKU: {{ product.sku or '-' }}
                                        {% if product.barcode %} | {{ product.barcode }}{% endif %}
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary fs-6">{{ product.system_qty }} {{ product.unit }}</span>
                                </td>
                                <td>
                                    <input type="number" class="form-control text-center physical-qty"
                                           name="physical_qty_{{ product.id }}"
                                           data-product-id="{{ product.id }}"
                                           data-system-qty="{{ product.system_qty }}"
                                           value="{{ product.system_qty }}"
                                           step="0.01" min="0" required>
                                </td>
                                <td class="text-center">
                                    <span class="variance-display badge fs-6" id="variance_{{ product.id }}">0</span>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm reason-select"
                                            name="reason_{{ product.id }}"
                                            id="reason_{{ product.id }}"
                                            disabled>
                                        <option value="">Select reason...</option>
                                        <option value="counting_error">Counting Error</option>
                                        <option value="damage">Damage/Breakage</option>
                                        <option value="theft">Suspected Theft</option>
                                        <option value="system_error">System Error</option>
                                        <option value="return_not_recorded">Return Not Recorded</option>
                                        <option value="sample_given">Sample Given</option>
                                        <option value="other">Other</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Raw Materials Section (for warehouses) -->
        {% if raw_materials %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Raw Materials ({{ raw_materials|length }} items)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px">#</th>
                                <th>Raw Material</th>
                                <th class="text-center">System Qty</th>
                                <th class="text-center" style="width: 150px">Physical Count</th>
                                <th class="text-center">Variance</th>
                                <th style="width: 200px">Reason (if variance)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rm in raw_materials %}
                            <tr id="rm_row_{{ rm.id }}">
                                <td>
                                    <input type="hidden" name="rm_ids[]" value="{{ rm.id }}">
                                    <input type="hidden" name="rm_system_qty_{{ rm.id }}" value="{{ rm.system_qty }}">
                                    <input type="hidden" name="rm_unit_cost_{{ rm.id }}" value="{{ rm.cost }}">
                                    {{ loop.index }}
                                </td>
                                <td>
                                    <strong>{{ rm.name }}</strong>
                                    <div class="small text-muted">SKU: {{ rm.sku or '-' }}</div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary fs-6">{{ rm.system_qty }} {{ rm.unit }}</span>
                                </td>
                                <td>
                                    <input type="number" class="form-control text-center rm-physical-qty"
                                           name="rm_physical_qty_{{ rm.id }}"
                                           data-rm-id="{{ rm.id }}"
                                           data-system-qty="{{ rm.system_qty }}"
                                           value="{{ rm.system_qty }}"
                                           step="0.001" min="0" required>
                                </td>
                                <td class="text-center">
                                    <span class="variance-display badge fs-6" id="rm_variance_{{ rm.id }}">0</span>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm rm-reason-select"
                                            name="rm_reason_{{ rm.id }}"
                                            id="rm_reason_{{ rm.id }}"
                                            disabled>
                                        <option value="">Select reason...</option>
                                        <option value="counting_error">Counting Error</option>
                                        <option value="spillage">Spillage/Wastage</option>
                                        <option value="evaporation">Evaporation</option>
                                        <option value="damage">Damage</option>
                                        <option value="system_error">System Error</option>
                                        <option value="production_variance">Production Variance</option>
                                        <option value="other">Other</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Summary & Notes -->
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h3 mb-0" id="totalItems">{{ products|length + raw_materials|length }}</div>
                                <small class="text-muted">Items Checked</small>
                            </div>
                            <div class="col-4">
                                <div class="h3 mb-0 text-success" id="matchedItems">0</div>
                                <small class="text-muted">Matched</small>
                            </div>
                            <div class="col-4">
                                <div class="h3 mb-0 text-danger" id="varianceItems">0</div>
                                <small class="text-muted">Variance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" name="notes" rows="3"
                                  placeholder="Add any observations or notes..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                <i class="fas fa-check-circle me-2"></i>Complete Spot Check
            </button>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>No products found at this location to check.
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const physicalInputs = document.querySelectorAll('.physical-qty');
    const rmPhysicalInputs = document.querySelectorAll('.rm-physical-qty');

    function updateVariance(input, prefix = '') {
        const id = input.dataset.productId || input.dataset.rmId;
        const systemQty = parseFloat(input.dataset.systemQty) || 0;
        const physicalQty = parseFloat(input.value) || 0;
        const variance = physicalQty - systemQty;

        const varianceEl = document.getElementById(prefix + 'variance_' + id);
        const reasonEl = document.getElementById(prefix + 'reason_' + id);
        const row = document.getElementById(prefix + 'row_' + id);

        varianceEl.textContent = variance.toFixed(2);

        if (variance === 0) {
            varianceEl.className = 'variance-display badge fs-6 bg-success';
            reasonEl.disabled = true;
            reasonEl.value = '';
            row.classList.remove('table-warning', 'table-danger');
        } else if (variance > 0) {
            varianceEl.className = 'variance-display badge fs-6 bg-warning text-dark';
            reasonEl.disabled = false;
            row.classList.add('table-warning');
            row.classList.remove('table-danger');
        } else {
            varianceEl.className = 'variance-display badge fs-6 bg-danger';
            reasonEl.disabled = false;
            row.classList.add('table-danger');
            row.classList.remove('table-warning');
        }

        updateSummary();
    }

    function updateSummary() {
        let matched = 0;
        let variance = 0;

        document.querySelectorAll('.physical-qty, .rm-physical-qty').forEach(input => {
            const systemQty = parseFloat(input.dataset.systemQty) || 0;
            const physicalQty = parseFloat(input.value) || 0;
            if (physicalQty === systemQty) {
                matched++;
            } else {
                variance++;
            }
        });

        document.getElementById('matchedItems').textContent = matched;
        document.getElementById('varianceItems').textContent = variance;
    }

    physicalInputs.forEach(input => {
        input.addEventListener('change', () => updateVariance(input, ''));
        input.addEventListener('input', () => updateVariance(input, ''));
    });

    rmPhysicalInputs.forEach(input => {
        input.addEventListener('change', () => updateVariance(input, 'rm_'));
        input.addEventListener('input', () => updateVariance(input, 'rm_'));
    });

    // Initial update
    updateSummary();

    // Form validation
    document.getElementById('spotCheckForm').addEventListener('submit', function(e) {
        let hasVariance = false;
        let missingReason = false;

        document.querySelectorAll('.physical-qty, .rm-physical-qty').forEach(input => {
            const id = input.dataset.productId || input.dataset.rmId;
            const prefix = input.classList.contains('rm-physical-qty') ? 'rm_' : '';
            const systemQty = parseFloat(input.dataset.systemQty) || 0;
            const physicalQty = parseFloat(input.value) || 0;

            if (physicalQty !== systemQty) {
                hasVariance = true;
                const reasonEl = document.getElementById(prefix + 'reason_' + id);
                if (!reasonEl.value) {
                    missingReason = true;
                    reasonEl.classList.add('is-invalid');
                } else {
                    reasonEl.classList.remove('is-invalid');
                }
            }
        });

        if (missingReason) {
            e.preventDefault();
            alert('Please provide a reason for each variance.');
            return false;
        }

        if (hasVariance) {
            if (!confirm('There are variances in this spot check. They will require manager approval. Continue?')) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}
