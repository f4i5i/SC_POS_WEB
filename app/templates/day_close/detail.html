{% extends "base.html" %}

{% block title %}Day Close Detail - {{ day_close.close_date }} - {{ business_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-file-invoice text-primary me-2"></i>Day Close Detail</h2>
            <p class="text-muted mb-0">
                {{ day_close.location.name if day_close.location else 'N/A' }} |
                {{ day_close.close_date.strftime('%A, %B %d, %Y') }}
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('day_close.z_report', close_id=day_close.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-file-alt me-2"></i>Z-Report
            </a>
            <button onclick="window.print()" class="btn btn-outline-secondary">
                <i class="fas fa-print me-2"></i>Print
            </button>
            <a href="{{ url_for('day_close.history') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-6">
            <!-- Basic Info Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Day Close Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <td class="text-muted">Z-Report Number</td>
                            <td class="text-end"><code>{{ day_close.z_report_number or 'N/A' }}</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Location</td>
                            <td class="text-end">{{ day_close.location.name if day_close.location else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Closed By</td>
                            <td class="text-end">{{ day_close.user.full_name if day_close.user else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Closed At</td>
                            <td class="text-end">{{ day_close.closed_at.strftime('%d %b %Y %H:%M') if day_close.closed_at else 'N/A' }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Sales Summary Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Sales Summary</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <td>Total Transactions</td>
                            <td class="text-end fw-bold">{{ day_close.total_sales }}</td>
                        </tr>
                        <tr>
                            <td>Gross Sales</td>
                            <td class="text-end">{{ format_currency(day_close.gross_sales or 0) }}</td>
                        </tr>
                        <tr class="text-danger">
                            <td>(-) Discounts</td>
                            <td class="text-end">{{ format_currency(day_close.total_discounts or 0) }}</td>
                        </tr>
                        <tr>
                            <td>(+) Tax</td>
                            <td class="text-end">{{ format_currency(day_close.total_tax or 0) }}</td>
                        </tr>
                        <tr class="table-success fw-bold">
                            <td>Net Sales</td>
                            <td class="text-end">{{ format_currency(day_close.net_sales or 0) }}</td>
                        </tr>
                        {% if day_close.total_refunds > 0 %}
                        <tr class="text-danger">
                            <td>Refunds</td>
                            <td class="text-end">{{ format_currency(day_close.total_refunds) }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Payment Breakdown Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Payment Breakdown</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <td><i class="fas fa-money-bill text-success me-2"></i>Cash</td>
                            <td class="text-end fw-bold">{{ format_currency(day_close.total_cash or 0) }}</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-credit-card text-primary me-2"></i>Card</td>
                            <td class="text-end">{{ format_currency(day_close.total_card or 0) }}</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-mobile-alt text-info me-2"></i>EasyPaisa</td>
                            <td class="text-end">{{ format_currency(day_close.total_easypaisa or 0) }}</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-mobile-alt text-danger me-2"></i>JazzCash</td>
                            <td class="text-end">{{ format_currency(day_close.total_jazzcash or 0) }}</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-university text-secondary me-2"></i>Bank Transfer</td>
                            <td class="text-end">{{ format_currency(day_close.total_bank_transfer or 0) }}</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-hand-holding-usd text-warning me-2"></i>Credit</td>
                            <td class="text-end">{{ format_currency(day_close.total_credit or 0) }}</td>
                        </tr>
                        {% if day_close.total_other > 0 %}
                        <tr>
                            <td>Other</td>
                            <td class="text-end">{{ format_currency(day_close.total_other) }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-6">
            <!-- Cash Reconciliation Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header {% if day_close.cash_variance == 0 %}bg-success{% elif day_close.cash_variance > 0 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Cash Reconciliation</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Opening Balance</td>
                            <td class="text-end">{{ format_currency(day_close.opening_balance or 0) }}</td>
                        </tr>
                        <tr>
                            <td>(+) Cash Sales</td>
                            <td class="text-end text-success">{{ format_currency(day_close.total_cash or 0) }}</td>
                        </tr>
                        {% if day_close.cash_in > 0 %}
                        <tr>
                            <td>(+) Cash In</td>
                            <td class="text-end text-success">{{ format_currency(day_close.cash_in) }}</td>
                        </tr>
                        {% endif %}
                        {% if day_close.cash_out > 0 %}
                        <tr>
                            <td>(-) Cash Out</td>
                            <td class="text-end text-danger">{{ format_currency(day_close.cash_out) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="table-primary fw-bold">
                            <td>Expected Cash</td>
                            <td class="text-end">{{ format_currency(day_close.expected_cash or 0) }}</td>
                        </tr>
                        <tr class="fw-bold">
                            <td>Counted Cash</td>
                            <td class="text-end">{{ format_currency(day_close.closing_balance or 0) }}</td>
                        </tr>
                        <tr class="{% if day_close.cash_variance == 0 %}table-success{% elif day_close.cash_variance > 0 %}table-warning{% else %}table-danger{% endif %} fw-bold">
                            <td>Variance</td>
                            <td class="text-end">
                                {% if day_close.cash_variance > 0 %}+{% endif %}{{ format_currency(day_close.cash_variance or 0) }}
                            </td>
                        </tr>
                    </table>

                    {% if day_close.cash_variance != 0 %}
                    <div class="alert {% if day_close.variance_status == 'approved' %}alert-success{% elif day_close.variance_status == 'rejected' %}alert-danger{% else %}alert-warning{% endif %} mb-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Status: {{ day_close.variance_status|capitalize }}</strong>
                                {% if day_close.approved_by_user %}
                                <br><small>By {{ day_close.approved_by_user.full_name }} on {{ day_close.variance_approved_at.strftime('%d %b %Y %H:%M') if day_close.variance_approved_at else 'N/A' }}</small>
                                {% endif %}
                                {% if day_close.variance_reason %}
                                <br><small>Reason: {{ day_close.variance_reason }}</small>
                                {% endif %}
                            </div>
                            {% if day_close.variance_status == 'pending' and current_user.is_global_admin %}
                            <div>
                                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">
                                    Approve
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Denomination Count Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Denomination Count</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Denomination</th>
                                <th class="text-center">Count</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if day_close.denom_5000 > 0 %}
                            <tr>
                                <td>Rs. 5,000</td>
                                <td class="text-center">{{ day_close.denom_5000 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_5000 * 5000) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_1000 > 0 %}
                            <tr>
                                <td>Rs. 1,000</td>
                                <td class="text-center">{{ day_close.denom_1000 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_1000 * 1000) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_500 > 0 %}
                            <tr>
                                <td>Rs. 500</td>
                                <td class="text-center">{{ day_close.denom_500 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_500 * 500) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_100 > 0 %}
                            <tr>
                                <td>Rs. 100</td>
                                <td class="text-center">{{ day_close.denom_100 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_100 * 100) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_50 > 0 %}
                            <tr>
                                <td>Rs. 50</td>
                                <td class="text-center">{{ day_close.denom_50 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_50 * 50) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_20 > 0 %}
                            <tr>
                                <td>Rs. 20</td>
                                <td class="text-center">{{ day_close.denom_20 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_20 * 20) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_10 > 0 %}
                            <tr>
                                <td>Rs. 10</td>
                                <td class="text-center">{{ day_close.denom_10 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_10 * 10) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_5 > 0 %}
                            <tr>
                                <td>Rs. 5</td>
                                <td class="text-center">{{ day_close.denom_5 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_5 * 5) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_2 > 0 %}
                            <tr>
                                <td>Rs. 2</td>
                                <td class="text-center">{{ day_close.denom_2 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_2 * 2) }}</td>
                            </tr>
                            {% endif %}
                            {% if day_close.denom_1 > 0 %}
                            <tr>
                                <td>Rs. 1</td>
                                <td class="text-center">{{ day_close.denom_1 }}</td>
                                <td class="text-end">{{ format_currency(day_close.denom_1 * 1) }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                        <tfoot class="table-primary fw-bold">
                            <tr>
                                <td colspan="2">Total Counted</td>
                                <td class="text-end">{{ format_currency(day_close.counted_total or day_close.closing_balance or 0) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Notes Card -->
            {% if day_close.notes %}
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ day_close.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Today's Sales Table -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Sales Transactions</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Sale #</th>
                            <th>Time</th>
                            <th>Customer</th>
                            <th class="text-center">Items</th>
                            <th class="text-end">Total</th>
                            <th>Payment</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in sales %}
                        <tr>
                            <td><code>{{ sale.sale_number }}</code></td>
                            <td>{{ sale.sale_date.strftime('%H:%M') }}</td>
                            <td>{{ sale.customer.name if sale.customer else 'Walk-in' }}</td>
                            <td class="text-center">{{ sale.items.count() }}</td>
                            <td class="text-end fw-bold">{{ format_currency(sale.total) }}</td>
                            <td>
                                <span class="badge {% if sale.payment_method == 'cash' %}bg-success{% elif sale.payment_method == 'card' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ sale.payment_method }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if sale.status == 'completed' %}bg-success{% elif sale.status == 'refunded' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ sale.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
{% if day_close.variance_status == 'pending' and day_close.cash_variance != 0 %}
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('day_close.approve_variance', close_id=day_close.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Approve/Reject Variance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert {% if day_close.cash_variance > 0 %}alert-warning{% else %}alert-danger{% endif %}">
                        Variance: <strong>{% if day_close.cash_variance > 0 %}+{% endif %}{{ format_currency(day_close.cash_variance) }}</strong>
                        ({% if day_close.cash_variance > 0 %}Over{% else %}Short{% endif %})
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason/Comment</label>
                        <textarea name="reason" class="form-control" rows="3" placeholder="Enter reason for approval/rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="action" value="reject" class="btn btn-danger">Reject</button>
                    <button type="submit" name="action" value="approve" class="btn btn-success">Approve</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
@media print {
    .btn, .no-print { display: none !important; }
    .card { box-shadow: none !important; border: 1px solid #dee2e6 !important; }
    .sidebar, .navbar { display: none !important; }
    .main-content { margin-left: 0 !important; padding: 0 !important; }
}
</style>
{% endblock %}
